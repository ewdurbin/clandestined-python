
try:
    import __pypy__
    MURMUR3_IS_PYPY = True
except ImportError:
    MURMUR3_IS_PYPY = False

try:
    from . import _murmur3
    MURMUR3_FALLBACK = False
except ImportError:
    MURMUR3_FALLBACK = True


if MURMUR3_IS_PYPY or MURMUR3_FALLBACK:
    def murmur3_32(data, seed = 0):
        """MurmurHash3 was written by Austin Appleby, and is placed in the
           public domain. The author hereby disclaims copyright to this source
           code."""

        c1 = 0xcc9e2d51
        c2 = 0x1b873593

        length = len(data)
        h1 = seed
        roundedEnd = (length & 0xfffffffc)  # round down to 4 byte block
        for i in range(0, roundedEnd, 4):
          # little endian load order
          k1 = (ord(data[i]) & 0xff) | ((ord(data[i + 1]) & 0xff) << 8) | \
               ((ord(data[i + 2]) & 0xff) << 16) | (ord(data[i + 3]) << 24)
          k1 *= c1
          k1 = (k1 << 15) | ((k1 & 0xffffffff) >> 17) # ROTL32(k1,15)
          k1 *= c2

          h1 ^= k1
          h1 = (h1 << 13) | ((h1 & 0xffffffff) >> 19)  # ROTL32(h1,13)
          h1 = h1 * 5 + 0xe6546b64

        # tail
        k1 = 0

        val = length & 0x03
        if val == 3:
            k1 = (ord(data[roundedEnd + 2]) & 0xff) << 16
        # fallthrough
        if val in [2, 3]:
            k1 |= (ord(data[roundedEnd + 1]) & 0xff) << 8
        # fallthrough
        if val in [1, 2, 3]:
            k1 |= ord(data[roundedEnd]) & 0xff
            k1 *= c1
            k1 = (k1 << 15) | ((k1 & 0xffffffff) >> 17)  # ROTL32(k1,15)
            k1 *= c2
            h1 ^= k1

        # finalization
        h1 ^= length

        # fmix(h1)
        h1 ^= ((h1 & 0xffffffff) >> 16)
        h1 *= 0x85ebca6b
        h1 ^= ((h1 & 0xffffffff) >> 13)
        h1 *= 0xc2b2ae35
        h1 ^= ((h1 & 0xffffffff) >> 16)

        return h1 & 0xffffffff

else:
    murmur3_32 = _murmur3.murmur3_32
